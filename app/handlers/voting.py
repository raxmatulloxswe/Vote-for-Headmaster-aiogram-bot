from aiogram import Router, Botfrom aiogram.filters.state import StateFilterfrom aiogram.fsm.context import FSMContextfrom aiogram.types import CallbackQueryfrom app.keyboards.inline import inline_main_menu, inline_subscribefrom app.utils.states import VoteStateGroupfrom app.utils.db_manager import dbimport configrouter = Router()last_bot_message = None@router.callback_query(lambda c: c.data == 'check_subscription')async def check_subscription(callback_query: CallbackQuery, bot: Bot, state: FSMContext):    user = callback_query.from_user    chat_member = await bot.get_chat_member(chat_id=config.SUBSCRIPTION_CHANNEL_ID, user_id=user.id)    if chat_member.status in ("member", "administrator", "creator"):        await callback_query.message.edit_text("""Olmaliq shaxridagi eng faol va ilgʻor maktab direktoriga OVOZ BERING!\n    Eng koʻp ovoz toʻplagan maktab direktori Yangi yil bayrami arafasida “ENG NAMUNALI MAKTAB DIREKTORI - 2024” nominatsiyasi boʻyicha taqdirlanadi.\n    Soʻrovnoma 2024-yil xx-dekabr soat xx:xxga qadar davom etadi.""", reply_markup=await inline_main_menu())    else:        await bot.send_message(chat_id=user.id, text="Iltimos, kanalga obuna bo'ling!",                               reply_markup=inline_subscribe())    await state.set_state(VoteStateGroup.vote_director)@router.callback_query(StateFilter(VoteStateGroup.vote_director))async def process_director_vote(callback_query: CallbackQuery, state: FSMContext):    director_id = callback_query.data.split('_')[1]    director = await db.get_director_by_id(int(director_id))    user_id = callback_query.from_user.id    user = await db.get_user_by_id(user_id)    if user is None:        await db.create_user(user_id)        user = {"vote_director": None}    if user.get('id') is not None:        director_id_info = user['vote_director']        director = await db.get_director_by_id(director_id_info)        director_name = director['name'] if director else 'nomi aniqlanmadi'        return await callback_query.message.answer(            f"Siz allaqachon {director_name} ga ovoz bergansiz!", show_alert=True        )    if director:        director['score'] += 1        await db.update_director_score(director_id, director['score'])        updated = await db.update_user_vote(user_id, director_id)        if updated:            await callback_query.bot.send_message(                chat_id=config.ADMIN_ID,                text=f"Foydalanuvchi ID: {user_id}\nNAME: {callback_query.from_user.full_name}\n\n direktor (ID: {director_id}) ga ovoz berdi!!"            )        await callback_query.message.answer(f"Rahmat! Siz {director['name']} ga ovoz berdingiz.")    await state.clear()